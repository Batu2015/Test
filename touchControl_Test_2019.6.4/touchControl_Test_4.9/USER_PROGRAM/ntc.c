#include "BS67F350.h"
#include "ntc.h"

#define u8 unsigned char
#define u16 unsigned int


//#define N 8 //ADC采样使用递推平均滤波算法，采样次数

#define FILTER_N 20
unsigned int  filter_buf[FILTER_N];
unsigned int ADC_VALUE = 0;
unsigned char  index1=0;
 
	
//unsigned int  filter_buf[N+1];
unsigned char ADCcount = 0;    //ADC采样次数变量  

//NTC使用MF52-103/3435;10K±1％精度;B值:3435±1％

//939,978,1017
//const unsigned int temptab11[]={  //0 to 99℃   10k ntc 3950 5%精度
// 939,978,1017,1058,1098,1140,1182,1225,1269,1313,
//1357,1402,1448,1493,1539,1585,1632,1678,1725,1771,
//1818,1864,1910,1956,2002,2048,2093,2138,2183,2227,
//2271,2314,2357,2399,2441,2482,2522,2562,2601,2639,
//2677,2714,2750,2786,2821,2855,2888,2921,2953,2984,
//3014,3044,3073,3101,3129,3156,3182,3208,3233,3257,
//3280,3303,3326,3347,3368,3389,3409,3428,3447,3465,
//3483,3500,3517,3533,3549,3564,3579,3594,3608,3621,
//3634,3647,3660,3672,3683,3695,3706,3716,3727,3737,
//3746,3756,3765,3774,3782,3791,3799,3807,3814,3822,
//};

 //0 to 99℃   10k ntc 3435 1%精度
const unsigned int temptab[]={  //0 to 100℃ step 1
1058,1095,1132,1169,1207,1245,1284,1323,1362,1402,
1442,1482,1522,1563,1603,1644,1685,1725,1766,1807,
1847,1888,1928,1968,2008,2048,2087,2127,2165,2204,
2242,2280,2317,2354,2390,2426,2462,2497,2532,2566,
2599,2632,2665,2697,2728,2759,2789,2819,2848,2877,
2905,2932,2959,2986,3011,3037,3062,3086,3110,3133,
3155,3178,3199,3220,3241,3261,3281,3300,3319,3337,
3355,3373,3390,3407,3423,3439,3454,3469,3484,3498,
3512,3526,3539,3552,3565,3577,3589,3601,3612,3623,
3634,3644,3655,3665,3674,3684,3693,3702,3711,3720,
3728,
};

#if 0
const unsigned int NTCcode[] = {
1043,//-1
1077,
1112,
1147,
1183,
1218,
1254,
1290,
1326,
1362,
1398,
1434,
1438,
1455,
1482,
1518,
1559,
1604,
1652,
1703,
1754,
1805,
1856,
1906,
1955,
2002,
2048,
2092,
2135,
2177,
2217,
2256,
2293,
2330,
2366,
2401,
2436,
2470,
2504,	
};
#endif

const unsigned int Ad_Value_table[]={
	#if 0
779  //0
,770  //1
,760  //2
,751  //3
,741  //4
,731  //5
,721  //6
,711  //7
,700  //8
,690  //9
,679  //10
,668  //11
,657  //12
,646  //13
,635  //14
,624  //15
,613  //16
,602  //17
,591  //18
,579  //19
,568  //20
,557  //21
,546  //22
,534  //23
,523  //24
,512  //25
,501  //26
,490  //27
,479  //28
,468  //29
,457  //30
,446  //31
,436  //32
,425  //33
,415  //34
,405  //35
,395  //36
,385  //37
,375  //38
,365  //39
,356  //40
,347  //41
,337  //42
,328  //43
,320  //44
,311  //45
,303  //46
,294  //47
,286  //48
,278  //49
,271  //50
,263  //51
,256  //52
,248  //53
,241  //54
,235  //55
,228  //56
,221  //57
,215  //58
,209  //59
,203  //60
,197  //61
,191  //62
,186  //63
,181  //64
,175  //65
,170  //66
,165  //67
,161  //68
,156  //69
,151  //70
,147  //71
,143  //72
,139  //73
,135  //74
,131  //75
,127  //76
,123  //77
,120  //78
,116  //79
,113  //80
,110  //81
,107  //82
,104  //83
,101  //84
,98  //85
,95  //86
,93  //87
,90  //88
,88  //89
,85  //90
,83  //91
,81  //92
,78  //93
,76  //94
,74  //95
,72  //96
,70  //97
,68  //98
,66  //99
,65  //100
,63  //101
,61  //102
,60  //103
,58  //104
,227  //105
#endif
};

#if 0
const unsigned int NTCcode[] = {
	/*ADC采样值****温度值*******电阻值**********/   
	   /* 0x033,  // -40.00       190.5562
	    0x034,  // -39.00       183.4132
	    0x037,  // -38.00       175.6740
	    0x039,  // -37.00       167.6467
	    0x03c,  // -36.00       159.5647
	    0x03f,  // -35.00       151.5975
	    0x042,  // -34.00       143.8624
	    0x045,  // -33.00       136.4361
	    0x049,  // -32.00       129.3641
	    0x04d,  // -31.00       122.6678
	    0x050,  // -30.00       116.3519
	    0x054,  // -29.00       110.4098
	    0x059,  // -28.00       104.8272
	    0x05d,  // -27.00       99.5847
	    0x061,  // -26.00       94.6608
	    0x066,  // -25.00       90.0326
	    0x06a,  // -24.00       85.6778
	    0x06f,  // -23.00       81.5747
	    0x074,  // -22.00       77.7031
	    0x079,  // -21.00       74.0442
	    0x07e,  // -20.00       70.5811
	    0x084,  // -19.00       67.2987
	    0x089,  // -18.00       64.1834
	    0x08f,  // -17.00       61.2233
	    0x095,  // -16.00       58.4080
	    0x09b,  // -15.00       55.7284
	    0x0a1,  // -14.00       53.1766
	    0x0a8,  // -13.00       50.7456
	    0x0af,  // -12.00       48.4294
	    0x0b5,  // -11.00       46.2224
	    0x0bd,  // -10.00       44.1201
	    0x0c4,  // -9.00        42.1180
	    0x0cb,  // -8.00        40.2121
	    0x0d3,  // -7.00        38.3988
	    0x0db,  // -6.00        36.6746
	    0x0e3,  // -5.00        35.0362
	    0x0eb,  // -4.00        33.4802
	    0x0f3,  // -3.00        32.0035
	    0x0fb,  // -2.00        30.6028
	    0x0104, // -1.00        29.2750*/
	    0x010d, // 0.00     28.0170
	    0x0115, // 1.00     26.8255
	    0x011e, // 2.00     25.6972
	    0x0127, // 3.00     24.6290
	    0x0130, // 4.00     23.6176
	    0x0139, // 5.00     22.6597
	    0x0142, // 6.00     21.7522
	    0x014b, // 7.00     20.8916
	    0x0154, // 8.00     20.0749
	    0x015d, // 9.00     19.2988
	    0x0166, // 10.00        18.5600
	    0x0167, // 11.00        18.4818
	    0x016b, // 12.00        18.1489
	    0x0172, // 13.00        17.6316
	    0x017b, // 14.00        16.9917
	    0x0185, // 15.00        16.2797
	    0x0190, // 16.00        15.5350
	    0x019c, // 17.00        14.7867
	    0x01a9, // 18.00        14.0551
	    0x01b6, // 19.00        13.3536
	    0x01c2, // 20.00        12.6900
	    0x01cf, // 21.00        12.0684
	    0x01dc, // 22.00        11.4900
	    0x01e8, // 23.00        10.9539
	    0x01f4, // 24.00        10.4582
	    0x01ff, // 25.00        10.0000
	    0x020a, // 26.00        9.5762
	    0x0215, // 27.00        9.1835
	    0x021f, // 28.00        8.8186
	    0x0229, // 29.00        8.4784
	    0x0233, // 30.00        8.1600
	    0x023c, // 31.00        7.8608
	    0x0245, // 32.00        7.5785
	    0x024e, // 33.00        7.3109
	    0x0257, // 34.00        7.0564
	    0x0260, // 35.00        6.8133
	    0x0268, // 36.00        6.5806
	    0x0271, // 37.00        6.3570
	    0x0279, // 38.00        6.1418
	    0x0282, // 39.00        5.9343
	    0x028a, // 40.00        5.7340
	    0x0292, // 41.00        5.5405
	    0x029a, // 42.00        5.3534
	    0x02a2, // 43.00        5.1725
	    0x02aa, // 44.00        4.9976
	    0x02b1, // 45.00        4.8286
	    0x02b9, // 46.00        4.6652
	    0x02c1, // 47.00        4.5073
	    0x02c8, // 48.00        4.3548
	    0x02d0, // 49.00        4.2075
	    0x02d7, // 50.00        4.0650
	    0x02de, // 51.00        3.9271
	    0x02e5, // 52.00        3.7936
	    0x02ec, // 53.00        3.6639
	    0x02f3, // 54.00        3.5377
	    0x02fa, // 55.00        3.4146
	    0x0301, // 56.00        3.2939
	    0x0308, // 57.00        3.1752
	    0x030f, // 58.00        3.0579
	    0x0316, // 59.00        2.9414
	   /* 0x031d, // 60.00        2.8250
	    0x0320, // 61.00        2.7762
	    0x0324, // 62.00        2.7179
	    0x0328, // 63.00        2.6523
	    0x032d, // 64.00        2.5817
	    0x0331, // 65.00        2.5076
	    0x0336, // 66.00        2.4319
	    0x033b, // 67.00        2.3557
	    0x0341, // 68.00        2.2803
	    0x0346, // 69.00        2.2065
	    0x034b, // 70.00        2.1350
	    0x034f, // 71.00        2.0661
	    0x0354, // 72.00        2.0004
	    0x0358, // 73.00        1.9378
	    0x035d, // 74.00        1.8785
	    0x0361, // 75.00        1.8225
	    0x0365, // 76.00        1.7696
	    0x0368, // 77.00        1.7197
	    0x036c, // 78.00        1.6727
	    0x036f, // 79.00        1.6282
	    0x0372, // 80.00        1.5860
	    0x0376, // 81.00        1.5458
	    0x0378, // 82.00        1.5075
	    0x037b, // 83.00        1.4707
	    0x037e, // 84.00        1.4352
	    0x0381, // 85.00        1.4006
	    0x0383, // 86.00        1.3669
	    0x0386, // 87.00        1.3337
	    0x0389, // 88.00        1.3009
	    0x038b, // 89.00        1.2684
	    0x038e, // 90.00        1.2360
	    0x0391, // 91.00        1.2037
	    0x0393, // 92.00        1.1714
	    0x0396, // 93.00        1.1390
	    0x0399, // 94.00        1.1067
      0x039b, // 95.00        1.0744
	    0x039e, // 96.00        1.0422
	    0x03a1, // 97.00        1.0104
	    0x03a3, // 98.00        0.9789
	    0x03a6, // 99.00        0.9481
	    0x03a8, // 100.00       0.9180
	    0x03ab, // 101.00       0.8889
	    0x03ad, // 102.00       0.8610
	    0x03b0, // 103.00       0.8346
	    0x03b2, // 104.00       0.8099
	    0x03b4, // 105.00       0.7870
	    0x03b6, // 106.00       0.7665
	    0x03b7, // 107.00       0.7485
	    0x03b9, // 108.00       0.7334
	    0x03ba, // 109.00       0.7214
	    0x03ba  // 110.00       0.7130*/
};
#endif
	
void ntc_init()
{
//	_pbs1 = 0x33;//使能AN4,an5为ad口 
	_pbs10 = 1;//AN4
	_pbs11 = 1;
	
	_pbs12 = 1;//AN5
	_pbs13 = 1;
		
//	_atm = 1;//AD自动转换控制位
	_adcr0 = 0x30;//使能adc
	_adcr1 = 0x03;// sys/8  	
}

//获取指定通道的adc值
u16 getad(u8 ch)
{
	u16 temp;
	_adcr0 &= 0xf8;
	_adcr0 |= ch;//an4
	_start=0;//0->1->0  启动转换
	_start=1;
	_start=0;
	while(_adbz);//等待转换结束	
	temp=_adrh;
	temp<<=8;
	temp|=_adrl;
	return temp;
}


/*****************************************************************************************
			函数名称  : get_adc_value
			描述	  : 温度ADC的值的处理
			入口参数  : 无
			返回值    : 无
*****************************************************************************************/
unsigned int get_adc_value(u8 channel)
{
  unsigned int i, j;
  unsigned int filter_temp;
  for(i = 0; i < FILTER_N; i++) {
    filter_buf[i] = getad(channel);
  }
  // 采样值从小到大排列（冒泡法）
  for(j = 0; j < FILTER_N - 1; j++) {
    for(i = 0; i < FILTER_N - 1 - j; i++) {
      if(filter_buf[i] > filter_buf[i + 1]) {
        filter_temp = filter_buf[i];
        filter_buf[i] = filter_buf[i + 1];
        filter_buf[i + 1] = filter_temp;
      }
    }
  }
	ADC_VALUE= filter_buf[(FILTER_N - 1) / 2];
	return ADC_VALUE;
}

#if 0
unsigned int GetAdToTempature()//读AD值转换成温度
{
	unsigned int index=0;
    unsigned int space,poor,val,temp_val;
 	unsigned int Ad_Data;	
 	get_adc_value(4);
 	Ad_Data = ADC_VALUE;
 	
    for(index=0;index<101;index++)
    {
	    if(Ad_Value_table[index]<=Ad_Data&& Ad_Value_table[index+1]<Ad_Data)
	    {
			space=Ad_Value_table[index]-Ad_Value_table[index+1];//计算出两个AD值间距
			poor=Ad_Data-Ad_Value_table[index];            //计算出此次AD值比前一个大多少
			val=poor*10/space;//  计算出小数点数
			temp_val=index*10+(10-val);
			index1=	 index;
	   	  return  temp_val; 
	    }	
   }	
}
#endif

//获取温度
u8 GetTemp(u8 channel)
{
	u16 temp;
	unsigned int i;
//	unsigned int filter_temp;
		
	temp=get_adc_value(channel);//getad(4);
	if(temp>4000)
	{
		return 99;	
	}
	else if(temp<100)
	{
		return 0;
	}
	else
	{	
		for(i=0;i<100;i++)//查表获取温度值
		{
			if(temptab[i]>temp)	break;//-350
		}
		return i;
	}
}

#if 0
unsigned int Get_Temp(void)
{
	    unsigned char xx;
	    unsigned int sum,tempvalue;
	    sum = tempvalue =0; 
	    filter_buf[N]=getad(4);  //将ADC转换结果放数组最高位
	    if( ++ADCcount < 8)      //采样初期不使用递推滤波算法
    	{   
        	for(xx=0;xx<N;xx++)  //准备递推滤波算法的数据
	        {
	            filter_buf[xx]=filter_buf[xx+1];//所有数据循环左移
	        }
	        tempvalue=filter_buf[N];//采样初期使用当前采样值
	    }
	    else    //只有采样次数大于8次以后才使用递推滤波算法 
	    {
	        ADCcount=8; //采样次数超过8次后，固定设置为8
	        for(xx=0;xx<N;xx++)  //递推滤波算法
	        {
	            filter_buf[xx]=filter_buf[xx+1];//所有数据循环左移
	            sum+=filter_buf[xx];  //求和
	        }
	        tempvalue=sum/N;        //求平均值      
	    }   
    	xx=0;
    	
	    while( tempvalue > NTCcode[xx] ) //将当前温度值与温度表对比，得到所在位置
	    {   
	    	xx++;   
	    }
	 
	    tempvalue=xx*10 +( (tempvalue - NTCcode[xx-1])*10 +5 )/( NTCcode[xx] - NTCcode[xx-1] );
	    //插值法计算温度，将数据全部扩大10倍，使小数变为整数，+5是四舍五入
	 
	    tempvalue=tempvalue-27;//修正温度，比正常高2.7度(扩大10倍为27)
	 
	    //tempvalue=tempvalue-225;//修正温度，比正常高2.7度(扩大10倍为27)
	 
	    if(tempvalue>400)    //正温度(大于0度)
	    {
	        tempvalue=tempvalue-400;    //取得0°以上温度
// 	        if(tempvalue>999)//大于100度显示最高位
// 	        else             //小于100度不显示最高位
	    }
	    else    //负温度(小于0度)
	    {
	        tempvalue=410-tempvalue;    //取得0°以下温度
	        tempvalue +=1000;    //取得0°以下温度
	        //插值法计算温度，将数据全部扩大10倍，使小数变为整数，+5是四舍五入
	    }
	return tempvalue;
}
#endif	 